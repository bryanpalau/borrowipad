<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>iPad Borrowing System</title>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    :root{
      --primary:#4f46e5;
      --success:#10b981;
      --bg:#0f172a;
      --panel:#1e293b;
      --danger:#ef4444;
      --gray:#334155;
      --warning:#f59e0b;
      --vh:1vh;
    }

    *{ box-sizing:border-box; }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:#fff;
      margin:0;
      display:flex;
      flex-direction:column;
      height:calc(var(--vh) * 100);
      overflow:hidden;
      -webkit-user-select:none;
      -webkit-tap-highlight-color:transparent;
    }

    .header{
      padding:10px;
      background:var(--panel);
      border-bottom:1px solid var(--gray);
    }

    .mode-toggle{
      display:flex;
      background:#0f172a;
      border-radius:10px;
      padding:4px;
      margin:0 auto;
      max-width:520px;
    }

    .mode-btn{
      flex:1;
      padding:12px;
      border:none;
      border-radius:8px;
      font-weight:900;
      font-size:1rem;
      color:#94a3b8;
      background:none;
    }

    .mode-btn.active{
      background:var(--primary);
      color:#fff;
    }

    #reader-container{
      position:relative;
      padding:12px;
    }

    #reader{
      width:100%;
      height:320px;
      background:#000;
      border-radius:14px;
      overflow:hidden;
      border:2px solid var(--gray);
    }

    .start-overlay{
      position:absolute;
      inset:12px;
      background:rgba(15,23,42,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:14px;
      z-index:10;
    }

    .start-btn{
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:14px;
      padding:16px 20px;
      font-weight:900;
      font-size:1rem;
    }

    .overlay{
      flex:1;
      background:var(--panel);
      border-radius:24px 24px 0 0;
      padding:16px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    #userPanel{
      display:none;
      justify-content:space-between;
      padding:12px;
      background:#0f172a;
      border-radius:10px;
      border-left:4px solid var(--primary);
      margin-bottom:10px;
      font-weight:900;
    }

    .status-banner{
      text-align:center;
      padding:14px;
      border-radius:10px;
      font-weight:900;
      margin-bottom:10px;
    }

    .status-waiting{ background:var(--gray); }
    .status-success{ background:var(--success); }
    .status-error{ background:var(--danger); }
    .status-warning{ background:var(--warning); }

    #historyList{
      flex:1;
      overflow:auto;
      background:#0f172a;
      border-radius:12px;
      margin-bottom:12px;
      display:none;
    }

    .history-row{
      display:flex;
      justify-content:space-between;
      padding:12px;
      border-bottom:1px solid #334155;
      font-weight:900;
    }

    .delete-btn{
      background:rgba(239,68,68,0.2);
      border:1px solid var(--danger);
      color:#ff8080;
      border-radius:10px;
      padding:6px 10px;
      font-size:0.8rem;
      font-weight:900;
    }

    .action-bar{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
    }

    .btn-action{
      padding:14px;
      border:none;
      border-radius:12px;
      background:var(--gray);
      color:#fff;
      font-weight:900;
      font-size:1rem;
    }

    .btn-finish{ background:var(--primary); }

    /* Confirm modal */
    #confirmModal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    #confirmModal .box{
      background:#1e293b;
      padding:20px;
      border-radius:16px;
      width:90%;
      max-width:320px;
      text-align:center;
    }
    #confirmModal button{
      width:100%;
      margin-top:10px;
      padding:12px;
      border-radius:10px;
      border:none;
      font-weight:900;
      font-size:1rem;
    }
  </style>
</head>

<body>

<div class="header">
  <div class="mode-toggle">
    <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
    <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
  </div>
</div>

<div id="reader-container">
  <div id="reader"></div>
  <div id="startOverlay" class="start-overlay">
    <button class="start-btn" onclick="userStart()">Tap to Start Scanning</button>
  </div>
</div>

<div class="overlay">
  <div id="userPanel">
    <div>User: <span id="currentUserId"></span></div>
    <div id="sessionCount">Qty: 0</div>
  </div>

  <div id="statusBanner" class="status-banner status-waiting">TAP TO START</div>

  <div id="historyList"></div>

  <div class="action-bar">
    <button class="btn-action" onclick="clearAll()">Clear All</button>
    <button class="btn-action" onclick="toggleHistory()">Review</button>
    <button id="finishBtn" class="btn-action btn-finish" onclick="finishSession()">Finish & Save</button>
  </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal">
  <div class="box">
    <div style="font-weight:900;">Clear all scanned iPads?</div>
    <div style="margin:10px 0;color:#cbd5e1;">This cannot be undone.</div>
    <button style="background:#475569;color:#fff;" onclick="confirmCancel()">Cancel</button>
    <button style="background:#ef4444;color:#fff;" onclick="confirmOk()">Clear</button>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzIiBdQgkwI3vgJrgVktRoE6GPQYRGckS6MK9bzfy7SeLoy-7r03D2V0dWA2L0kShw_/exec";
const UNAVAILABLE_REFRESH_INTERVAL_MS = 5000;

let html5QrCode, scannerStarted=false;
let mode="borrow", userId=null, sessionHistory=[];
let historyDom=new Map(), confirmCallback=null, isProcessing=false;

function updateBanner(t,c){
  const b=document.getElementById("statusBanner");
  b.textContent=t;
  b.className="status-banner "+c;
}

function userStart(){
  document.getElementById("startOverlay").style.display="none";
  startScanner();
}

async function startScanner(){
  if(scannerStarted) return;
  html5QrCode=new Html5Qrcode("reader");
  await html5QrCode.start(
    {facingMode:"environment"},
    {fps:8,qrbox:260},
    onScan
  );
  scannerStarted=true;
  startScannerWatchdog();
  startUnavailableAutoRefresh();
  updateBanner("SCAN USER ID","status-waiting");
}

function onScan(txt){
  txt=txt.trim().toUpperCase();
  if(!userId){
    if(/^[ST]\d+/.test(txt)){
      userId=txt;
      document.getElementById("userPanel").style.display="flex";
      document.getElementById("currentUserId").textContent=txt;
      updateBanner("SCAN IPADS","status-success");
    } else {
      updateBanner("INVALID USER","status-error");
    }
    return;
  }

  if(!/^IPAD-\d+/.test(txt)){
    updateBanner("INVALID IPAD","status-error");
    return;
  }

  if(sessionHistory.includes(txt)) return;

  sessionHistory.push(txt);
  addRow(txt);
  updateBanner("ADDED "+txt,"status-success");
}

function addRow(id){
  const l=document.getElementById("historyList");
  l.style.display="block";
  const d=document.createElement("div");
  d.className="history-row";
  d.innerHTML=`<span>${id}</span><button class="delete-btn" onclick="removeRow('${id}')">DELETE</button>`;
  l.appendChild(d);
  historyDom.set(id,d);
  document.getElementById("sessionCount").textContent="Qty: "+sessionHistory.length;
}

function removeRow(id){
  sessionHistory=sessionHistory.filter(x=>x!==id);
  historyDom.get(id)?.remove();
  historyDom.delete(id);
  document.getElementById("sessionCount").textContent="Qty: "+sessionHistory.length;
}

function clearAll(){
  if(sessionHistory.length===0) return;
  confirmCallback=()=>{
    sessionHistory=[];
    historyDom.clear();
    document.getElementById("historyList").innerHTML="";
    document.getElementById("historyList").style.display="none";
    document.getElementById("sessionCount").textContent="Qty: 0";
    updateBanner("CLEARED","status-waiting");
    restartScanner();
  };
  document.getElementById("confirmModal").style.display="flex";
}

function confirmCancel(){
  confirmCallback=null;
  document.getElementById("confirmModal").style.display="none";
}

function confirmOk(){
  document.getElementById("confirmModal").style.display="none";
  confirmCallback?.();
  confirmCallback=null;
}

async function restartScanner(){
  try{
    if(html5QrCode?.isScanning){
      await html5QrCode.stop();
    }
    scannerStarted=false;
    await startScanner();
  }catch{}
}

function startScannerWatchdog(){
  setInterval(()=>{ if(!html5QrCode?.isScanning) restartScanner(); },1500);
}

function startUnavailableAutoRefresh(){
  setInterval(()=>{},UNAVAILABLE_REFRESH_INTERVAL_MS);
}

function toggleHistory(){
  const l=document.getElementById("historyList");
  l.style.display=l.style.display==="none"?"block":"none";
}

function setMode(m){
  mode=m;
  document.getElementById("btnBorrow").classList.toggle("active",m==="borrow");
  document.getElementById("btnReturn").classList.toggle("active",m==="return");
}

async function finishSession(){
  if(isProcessing||sessionHistory.length===0) return;
  isProcessing=true;
  updateBanner("SAVING...","status-warning");

  try{
    const r=await fetch(SCRIPT_URL,{
      method:"POST",
      body:JSON.stringify({action:mode,userId,ipadId:sessionHistory,requestId:crypto.randomUUID()})
    });
    const j=await r.json();
    if(j.success){
      updateBanner("SAVED","status-success");
      clearAll();
    }else{
      updateBanner("SAVE FAILED","status-error");
    }
  }catch{
    updateBanner("SAVE FAILED","status-error");
  }finally{
    isProcessing=false;
  }
}
</script>
</body>
</html>
